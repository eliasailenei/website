<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>COMP-1828 Group Finder</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<style>
  html, body {
    height: 100%;
    margin: 0;
    background: #0c0c0c;
    color: #f2f2f2;
    font-family: "Inter", "SF Pro Display", system-ui, sans-serif;
  }

  body {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    padding: 20px;
  }

  h1 {
    font-size: 1.8rem;
    font-weight: 600;
    margin-bottom: 0.4em;
  }

  p {
    font-size: 1rem;
    color: #aaa;
    margin-bottom: 1em;
    max-width: 90%;
  }

  input[type="file"],
  input[type="text"] {
    display: block;
    margin: 10px auto;
    padding: 14px 16px;
    border-radius: 12px;
    border: none;
    width: 100%;
    max-width: 400px;
    font-size: 1rem;
    background: #1a1a1a;
    color: #f2f2f2;
    box-shadow: inset 0 0 0 1px #333;
    transition: box-shadow 0.2s;
  }

  input[type="text"]::placeholder {
    color: #777;
  }

  input[type="file"]:focus,
  input[type="text"]:focus {
    outline: none;
    box-shadow: inset 0 0 0 1.5px #00bcd4;
  }

  button {
    padding: 12px 20px;
    margin: 15px 0;
    border-radius: 10px;
    border: none;
    background: #00bcd4;
    color: white;
    font-size: 1rem;
    font-weight: 600;
    width: 90%;
    max-width: 400px;
    cursor: pointer;
    transition: background 0.2s;
  }

  button:hover,
  button:active {
    background: #0097a7;
  }

  #results {
    background: #181818;
    border-radius: 14px;
    padding: 20px;
    margin-top: 20px;
    width: 100%;
    max-width: 600px;
    text-align: left;
    overflow-y: auto;
  }

  .group-member {
    border-bottom: 1px solid #333;
    padding: 10px 0;
    font-size: 0.95rem;
  }

  .copy-box {
    background: #222;
    padding: 12px;
    border-radius: 10px;
    margin-top: 10px;
    font-family: monospace;
    font-size: 0.9rem;
    overflow-x: auto;
    word-wrap: break-word;
  }

  @media (max-width: 600px) {
    h1 { font-size: 1.6rem; }
    p { font-size: 0.95rem; }
    input, button { font-size: 1rem; }
    #results { padding: 16px; }
  }
</style>
</head>
<body>
<h1>COMP-1828 Group Finder</h1>
<p>Upload the <b>CW_group_allocation_2025-26_v1_11Oct1617.pdf</b> file below. All parsing stays local.</p>
<input type="file" id="pdfFile" accept="application/pdf">
<br>
<input type="text" id="searchBox" placeholder="Search by group number (e.g. 11-3) or name...">
<div id="results"></div>

<script>
let db = [];

async function extractTextFromPDF(file) {
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
  let text = "";
  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    const strings = content.items.map(item => item.str);
    text += strings.join(" ") + "\n";
  }
  return text;
}

function parseDatabase(text) {
  const lines = text.split(/\n|(?=[A-Z][a-z]+,)/);
  const pattern = /([\w'.\- ]+), ([A-Za-z \-']+).*?\[(\d+)\]\s*(\d{2}-\d)\s*[\s\S]*?,\s*([\w\d]+@gre\.ac\.uk)/g;
  let match;
  while ((match = pattern.exec(text)) !== null) {
    db.push({
      name: (match[1] + " " + match[2]).trim(),
      id: match[3],
      group: match[4],
      email: match[5]
    });
  }

  // find lab colour per section header
  const colorMatches = [...text.matchAll(/Lab\s+(\d+).*?\((Black|Blue|.*?)\)/gi)];
  const labColors = {};
  for (const m of colorMatches) labColors[m[1]] = m[2];

  db.forEach(p => {
    const lab = p.group.split('-')[0];
    p.color = labColors[lab] || "Unknown";
  });
  localStorage.setItem("groupDB", JSON.stringify(db));
  alert(`Loaded ${db.length} entries.`);
}

document.getElementById("pdfFile").addEventListener("change", async e => {
  const file = e.target.files[0];
  if (!file) return;
  document.getElementById("results").innerHTML = "<p>Processing PDF, please wait...</p>";
  const text = await extractTextFromPDF(file);
  parseDatabase(text);
  document.getElementById("results").innerHTML = "<p>PDF processed. You can now search.</p>";
});

document.getElementById("searchBox").addEventListener("input", e => {
  const q = e.target.value.trim().toLowerCase();
  const resDiv = document.getElementById("results");
  if (!q) { resDiv.innerHTML = ""; return; }
  if (db.length === 0) {
    const cached = localStorage.getItem("groupDB");
    if (cached) db = JSON.parse(cached);
    else return resDiv.innerHTML = "<p>Please load the PDF first.</p>";
  }

  if (/^\d{2}-\d$/.test(q)) {
    // search by group number
    const members = db.filter(p => p.group.toLowerCase() === q);
    if (members.length === 0) return resDiv.innerHTML = "<p>No results found.</p>";
    let html = `<h2>Group ${q}</h2>`;
    html += `<p><b>Colour:</b> ${members[0].color}</p>`;
    html += members.map(m => `<div class="group-member">${m.name} — ${m.email}</div>`).join("");
    const emails = members.map(m => m.email).join("; ");
    html += `<div class="copy-box">${emails}</div>`;
    html += `<button onclick="navigator.clipboard.writeText('${emails}')">Copy Emails</button>`;
    resDiv.innerHTML = html;
  } else {
    // name search
    const matches = db.filter(p => p.name.toLowerCase().includes(q));
    if (matches.length === 0) return resDiv.innerHTML = "<p>No matches found.</p>";
    let html = "<h2>Search Results</h2>";
    html += matches.map(p => `<div class="group-member"><b>${p.name}</b> — Group ${p.group} (${p.color}) — ${p.email}</div>`).join("");
    resDiv.innerHTML = html;
  }
});
</script>
</body>
</html>
